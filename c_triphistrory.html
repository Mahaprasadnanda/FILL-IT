<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip History</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="c_triphistory.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<header>
    <div class="logo">
        <img src="logo.svg" alt="FILLit Logo" class="logo-img">
    </div>
    <div class="header-right">
        <select class="language-selector" aria-label="Select language" id="languageSelector">
            <option value="en">English</option>
            <option value="hi">हिंदी (Hindi)</option>
            <option value="or">ଓଡ଼ିଆ (Odia)</option>
            <option value="bn">বাংলা (Bengali)</option>
            <option value="ta">தமிழ் (Tamil)</option>
            <option value="te">తెలుగు (Telugu)</option>
            <option value="mr">मराठी (Marathi)</option>
        </select>
        <div class="profile">
            <img src="profile.png" alt="Profile" class="profile-icon">
            <div class="profile-popup">
                <div class="profile-header">
                    <img src="profile.png" alt="Profile" class="profile-header-img">
                    <h3 id="profileName">Loading...</h3>
                    <p class="profile-email" id="profileEmail">Loading...</p>
                </div>
                <div class="profile-info">
                    <div class="profile-info-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        <span class="phone-number" id="profilePhone">Loading...</span>
                        <button class="edit-phone-btn" title="Edit phone number">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="phone-edit-form" style="display: none;">
                        <input type="tel" class="phone-input" placeholder="Enter phone number">
                        <div class="phone-edit-actions">
                            <button class="save-phone-btn">Save</button>
                            <button class="cancel-phone-btn">Cancel</button>
                        </div>
                    </div>
                </div>
                <div class="profile-divider"></div>
                <a href="c_home.html" class="profile-option">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path>
                    </svg>
                    <span class="home-text">Home</span>
                </a>
                <div class="profile-divider"></div>
                <a href="#" class="profile-option sign-out" id="logoutBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span class="logout-text">Logout</span>
                </a>
            </div>
        </div>
    </div>
</header>
<main>
    <h1 class="trip-history-text">Trip History :</h1>
    <div id="tripHistoryContainer" class="trips-container"></div>
</main>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4_Aqci9_nRQZeOobtLws-UMdQ2-wZwaw",
  authDomain: "fill-it-19a6e.firebaseapp.com",
  projectId: "fill-it-19a6e",
  storageBucket: "fill-it-19a6e.firebasestorage.app",
  messagingSenderId: "372445174613",
  appId: "1:372445174613:web:f2cf03080810b7083f6ddc",
  measurementId: "G-XB9P25X1P8"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
window.auth = auth;
</script>
<script>
    function isLoggedIn() {
        return localStorage.getItem('idToken') && localStorage.getItem('email');
    }

    function handleUnauthorizedAccess() {
        localStorage.clear();
        sessionStorage.clear();
        window.location.replace('login.html');
    }

    if (!isLoggedIn()) {
        handleUnauthorizedAccess();
    }

    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible' && !isLoggedIn()) {
            handleUnauthorizedAccess();
        }
    });

    window.addEventListener('pageshow', function(event) {
        if (event.persisted && !isLoggedIn()) {
            handleUnauthorizedAccess();
        }
    });

    window.addEventListener('popstate', function(event) {
        if (!isLoggedIn()) {
            handleUnauthorizedAccess();
        }
    });

    const translations = {
        en: {
            tripHistory: "Trip History :",
            home: "Home",
            logout: "Logout"
        },
        hi: {
            tripHistory: "यात्रा इतिहास :",
            home: "होम",
            logout: "लॉग आउट"
        },
        or: {
            tripHistory: "ଯାତ୍ରା ଇତିହାସ :",
            home: "ହୋମ",
            logout: "ଲଗ୍ ଆଉଟ୍"
        },
        bn: {
            tripHistory: "ট্রিপ ইতিহাস :",
            home: "হোম",
            logout: "লগআউট"
        },
        ta: {
            tripHistory: "பயண வரலாறு :",
            home: "முகப்பு",
            logout: "வெளியேறு"
        },
        te: {
            tripHistory: "ప్రయాణ చరిత్ర :",
            home: "హోమ్",
            logout: "లాగ్అవుట్"
        },
        mr: {
            tripHistory: "प्रवास इतिहास :",
            home: "होम",
            logout: "लॉगआउट"
        }
    };

    document.addEventListener('DOMContentLoaded', async function() {
        if (!isLoggedIn()) {
            handleUnauthorizedAccess();
            return;
        }
        const user = window.auth.currentUser;
        if (!user) {
            handleUnauthorizedAccess();
            return;
        }
        const idToken = await user.getIdToken(true);
        const email = localStorage.getItem('email');
        try {
            const response = await fetch(`https://fill-it.onrender.com/get-profile?email=${encodeURIComponent(email)}`, {
                headers: {
                    'Authorization': `Bearer ${idToken}`
                }
            });
            if (!response.ok) {
                throw new Error('Failed to fetch profile');
            }
            const profileData = await response.json();
            document.getElementById('profileName').textContent = profileData.name || 'User';
            document.getElementById('profileEmail').textContent = email;
            document.getElementById('profilePhone').textContent = profileData.phone || 'Not set';
            document.querySelector('.phone-input').value = profileData.phone || '';
        } catch (error) {
            console.error('Error fetching profile:', error);
            alert('Failed to load profile data');
        }
    });

    const languageSelector = document.getElementById('languageSelector');
    let currentLang = languageSelector.value || 'en';

    languageSelector.addEventListener('change', function() {
        currentLang = this.value;
        const translation = translations[currentLang];
        document.querySelector('.trip-history-text').textContent = translation.tripHistory;
        document.querySelector('.home-text').textContent = translation.home;
        document.querySelector('.logout-text').textContent = translation.logout;
    });

    const profileIcon = document.querySelector('.profile');
    const profilePopup = document.querySelector('.profile-popup');
    let backdrop = null;

    function isMobile() {
        return window.matchMedia('(max-width: 480px)').matches;
    }

    function openProfilePopup() {
        profilePopup.classList.add('active');
        if (isMobile()) {
            document.body.classList.add('profile-open');
        }
    }

    function closeProfilePopup() {
        profilePopup.classList.remove('active');
        if (isMobile()) {
            document.body.classList.remove('profile-open');
        }
    }

    profileIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        if (profilePopup.classList.contains('active')) {
            closeProfilePopup();
        } else {
            openProfilePopup();
        }
    });

    document.addEventListener('click', function(e) {
        if (!profileIcon.contains(e.target) && !profilePopup.contains(e.target)) {
            closeProfilePopup();
        }
    });

    profilePopup.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    const editPhoneBtn = document.querySelector('.edit-phone-btn');
    const phoneNumber = document.querySelector('.phone-number');
    const phoneEditForm = document.querySelector('.phone-edit-form');
    const phoneInput = document.querySelector('.phone-input');
    const savePhoneBtn = document.querySelector('.save-phone-btn');
    const cancelPhoneBtn = document.querySelector('.cancel-phone-btn');

    editPhoneBtn.addEventListener('click', function() {
        phoneEditForm.style.display = 'block';
        phoneInput.focus();
    });

    savePhoneBtn.addEventListener('click', async function() {
        const newPhone = phoneInput.value.trim();
        if (newPhone) {
            try {
                const email = localStorage.getItem('email');
                const idToken = localStorage.getItem('idToken');

                const response = await fetch('https://fill-it.onrender.com/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        email: email,
                        phone: newPhone
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    phoneNumber.textContent = newPhone;
                    phoneEditForm.style.display = 'none';
                    alert('Phone number updated successfully!');
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update phone number');
                }
            } catch (error) {
                console.error('Error updating phone:', error);
                alert(error.message || 'Failed to update phone number');
            }
        }
    });

    cancelPhoneBtn.addEventListener('click', function() {
        phoneInput.value = phoneNumber.textContent;
        phoneEditForm.style.display = 'none';
    });

    document.getElementById('logoutBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        try {
            const idToken = localStorage.getItem('idToken');

            const response = await fetch('https://fill-it.onrender.com/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id_token: idToken })
            });

            if (response.ok) {
                localStorage.clear();
                sessionStorage.clear();

                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(
                            cacheNames.map(cacheName => caches.delete(cacheName))
                        );
                    } catch (error) {
                        console.error('Error clearing cache:', error);
                    }
                }

                if ('serviceWorker' in navigator) {
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        await Promise.all(
                            registrations.map(registration => registration.unregister())
                        );
                    } catch (error) {
                        console.error('Error unregistering service workers:', error);
                    }
                }

                window.location.replace('welcome.html');

                setTimeout(() => {
                    window.location.reload(true);
                    window.history.pushState(null, '', 'welcome.html');
                    window.history.pushState(null, '', 'welcome.html');
                    window.history.pushState(null, '', 'welcome.html');
                    window.onpopstate = function() {
                        window.history.pushState(null, '', 'welcome.html');
                    };
                }, 100);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Logout failed');
            }
        } catch (error) {
            console.error('Logout error:', error);
            alert(error.message || 'Failed to logout. Please try again.');
        }
    });

    async function fetchTripHistory() {
        try {
            const user = window.auth.currentUser;
            if (!user) {
                handleUnauthorizedAccess();
                return;
            }
            const idToken = await user.getIdToken(true);
            const email = localStorage.getItem('email');
            const response = await fetch(`https://fill-it.onrender.com/get-trip-history?email=${encodeURIComponent(email)}`, {
                headers: {
                    'Authorization': `Bearer ${idToken}`
                }
            });
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Trip history fetch error:', response.status, errorText);
                throw new Error('Failed to fetch trip history');
            }
            const data = await response.json();
            const container = document.getElementById('tripHistoryContainer');
            container.innerHTML = '';
            if (data.trips && data.trips.length > 0) {
                // Sort trips by status: driver_assigned > pending > regret > others
                const statusOrder = { 'driver_assigned': 1, 'pending': 2, 'regret': 3 };
                data.trips.sort((a, b) => {
                    const aOrder = statusOrder[a.status.status] || 99;
                    const bOrder = statusOrder[b.status.status] || 99;
                    return aOrder - bOrder;
                });
                data.trips.forEach(trip => {
                    const tripCard = document.createElement('div');
                    tripCard.className = 'trip-card';

                    // Only show edit/delete buttons for pending trips
                    const showActions = trip.status.status === 'pending';

                    const statusColor = {
                        'pending': '#FFD600',
                        'driver_assigned': '#344de3',
                        'trip_completed': '#00C853',
                        'regret': '#ff4d4d'
                    }[trip.status.status] || '#FFFFFF';

                    // Two-column layout: trip details left, driver details right
                    tripCard.innerHTML = `
                      <div class="trip-details-section">
                        <p><strong>FROM:</strong> ${trip.from_location}</p>
                        <p><strong>To:</strong> ${trip.to_location}</p>
                        <p><strong>Status:</strong> <span style="color: ${statusColor}">${trip.status.status.replace('_', ' ')}</span></p>
                        <p><strong>Created:</strong> ${formatDateTime(trip.created_at)}</p>
                        ${trip.updated_at ? `<p><strong>Last Updated:</strong> ${formatDateTime(trip.updated_at)}</p>` : ''}
                        ${showActions ? `
                            <div class="trip-actions">
                                <button class="edit-trip-btn" onclick="handleEditTrip('${trip.booking_id}', '${trip.from_location}', '${trip.to_location}', '${trip.date}')">
                                    <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">
                                        <path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"></path>
                                        <path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button class="delete-trip-btn" onclick="handleDeleteTrip('${trip.booking_id}')">
                                    <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">
                                        <polyline points=\"3 6 5 6 21 6\"></polyline>
                                        <path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"></path>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        ` : ''}
                      </div>
                      <div class="driver-details-section">
                        <p><strong>DATE:</strong> ${trip.date}</p>
                        <div class="driver-details" id="driverDetails-${trip.booking_id}">
                          ${(trip.status.driver_email) ? `
                            <p style='color:#888;'>Loading latest driver details...</p>
                          ` : ''}
                        </div>
                      </div>
                    `;
                    container.appendChild(tripCard);

                    // Fetch and update latest driver details if driver_email exists
                    if (trip.status.driver_email) {
                        const driverEmail = trip.status.driver_email;
                        user.getIdToken(true).then(driverIdToken => {
                            fetch(`https://fill-it.onrender.com/get-profile?email=${encodeURIComponent(driverEmail)}`, {
                                headers: { 'Authorization': `Bearer ${driverIdToken}` }
                            })
                            .then(res => res.json())
                            .then(driverProfile => {
                                const detailsDiv = document.getElementById(`driverDetails-${trip.booking_id}`);
                                detailsDiv.innerHTML = `
                                  <p><strong>DRIVER NAME:</strong> ${driverProfile.name || 'N/A'}</p>
                                  <p><strong class='driver-email-label'>DRIVER EMAIL:</strong> ${driverProfile.email || 'N/A'}</p>
                                  <p><strong class='driver-phone-label'>DRIVER PHONE:</strong> ${driverProfile.phone || 'N/A'}</p>
                                  <p><strong class='vehicle-label'>VEHICLE NUMBER:</strong> ${driverProfile.vehicle_number || 'N/A'}</p>
                                `;
                            })
                            .catch((err) => {
                                const detailsDiv = document.getElementById(`driverDetails-${trip.booking_id}`);
                                detailsDiv.innerHTML = `<p style='color:#e53935;'>Failed to load driver details</p>`;
                                console.error('Driver details fetch error:', err);
                            });
                        });
                    }
                });
            } else {
                container.innerHTML = '<p class="no-trips">No trips found</p>';
            }
        } catch (error) {
            console.error('Error fetching trip history:', error);
            alert('Failed to load trip history');
        }
    }

    async function handleEditTrip(tripId, currentFrom, currentTo, currentDate) {
        // Create a modal for editing
        const modalHtml = `
            <div class="edit-modal">
                <div class="edit-modal-content">
                    <h2>Edit Trip</h2>
                    <div class="edit-form">
                        <div class="form-group">
                            <label>From:</label>
                            <input type="text" id="editFrom" value="${currentFrom}" class="edit-input locationiq-input" placeholder="Enter pickup location">
                            <div id="editFromSuggestions" class="suggestions"></div>
                        </div>
                        <div class="form-group">
                            <label>To:</label>
                            <input type="text" id="editTo" value="${currentTo}" class="edit-input locationiq-input" placeholder="Enter drop location">
                            <div id="editToSuggestions" class="suggestions"></div>
                        </div>
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" id="editDate" value="${currentDate}" class="edit-input">
                        </div>
                        <div class="edit-actions">
                            <button class="save-edit-btn" onclick="saveEdit('${tripId}')">Save Changes</button>
                            <button class="cancel-edit-btn" onclick="closeEditModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Initialize Google Places Autocomplete for both fields
        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.maps) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAOXzRX48gcKoX4ndad2hcSPQ7hxFfdSJs&libraries=places';
                script.async = true;
                script.defer = true;
                script.onerror = reject;
                script.onload = () => resolve();
                document.head.appendChild(script);
            });
        }
        async function initEditAutocomplete() {
            await loadGoogleMapsAPI();
            new google.maps.places.Autocomplete(document.getElementById('editFrom'), { types: ['geocode'] });
            new google.maps.places.Autocomplete(document.getElementById('editTo'), { types: ['geocode'] });
        }
        initEditAutocomplete();
    }

    function closeEditModal() {
        const modal = document.querySelector('.edit-modal');
        if (modal) modal.remove();
    }

    async function saveEdit(tripId) {
        const newFrom = document.getElementById('editFrom').value;
        const newTo = document.getElementById('editTo').value;
        const newDate = document.getElementById('editDate').value;

        if (!newFrom || !newTo || !newDate) {
            alert('Please fill in all fields');
            return;
        }

        try {
            const idToken = localStorage.getItem('idToken');
            const response = await fetch(`https://fill-it.onrender.com/edit-trip/${tripId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                },
                body: JSON.stringify({
                    from_location: newFrom,
                    to_location: newTo,
                    date: newDate
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to update trip');
            }

            const data = await response.json();
            alert(data.message || 'Trip updated successfully!');
            closeEditModal();
            await fetchTripHistory(); // Refresh the list
        } catch (error) {
            console.error('Error updating trip:', error);
            alert(error.message || 'Failed to update trip. Please try again.');
        }
    }

    async function handleDeleteTrip(tripId) {
        if (!confirm('Are you sure you want to delete this trip?')) return;

        try {
            const idToken = localStorage.getItem('idToken');
            const response = await fetch(`https://fill-it.onrender.com/delete-trip/${tripId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${idToken}`
                }
            });

            if (response.ok) {
                alert('Trip deleted successfully!');
                fetchTripHistory(); // Refresh the list
            } else {
                throw new Error('Failed to delete trip');
            }
        } catch (error) {
            console.error('Error deleting trip:', error);
            alert('Failed to delete trip. Please try again.');
        }
    }

    // Add the formatDateTime helper function
    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return '';
        const date = new Date(dateTimeStr);
        return date.toLocaleString('en-IN', {
            timeZone: 'Asia/Kolkata',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    }

    // Call fetchTripHistory when the page loads
    document.addEventListener('DOMContentLoaded', fetchTripHistory);
</script>
</body>
</html>