<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book A Trip - FILLit</title>
    <link rel="stylesheet" href="c_home.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        #map {
            height: 100%;
            width: 100%;
            border-radius: 20px;
        }
        .autocomplete-input {
            width: 100%;
            height: 40px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: var(--transition);
        }
        .autocomplete-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(71, 98, 255, 0.1);
        }
        .location-section {
            width: 65%;
            height: 600px;
            background-color: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
        }
        .location-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
<header>
    <div class="logo">
        <img src="logo.svg" alt="FILLit Logo" class="logo-img">
    </div>
    <div class="header-right">
        <select class="language-selector" aria-label="Select language" id="languageSelector">
            <option value="en">English</option>
            <option value="hi">हिंदी (Hindi)</option>
            <option value="or">ଓଡ଼ିଆ (Odia)</option>
            <option value="bn">বাংলা (Bengali)</option>
            <option value="ta">தமிழ் (Tamil)</option>
            <option value="te">తెలుగు (Telugu)</option>
            <option value="mr">मराठी (Marathi)</option>
        </select>
        <div class="profile">
            <img src="profile.png" alt="Profile" class="profile-icon">
            <div class="profile-popup">
                <div class="profile-header">
                    <img src="profile.png" alt="Profile" class="profile-header-img">
                    <h3 id="profileName">Loading...</h3>
                    <p class="profile-email" id="profileEmail">Loading...</p>
                </div>
                <div class="profile-info">
                    <div class="profile-info-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        <span class="phone-number" id="profilePhone">Loading...</span>
                        <button class="edit-phone-btn" title="Edit phone number">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="phone-edit-form" style="display: none;">
                        <input type="tel" class="phone-input" placeholder="Enter phone number">
                        <div class="phone-edit-actions">
                            <button class="save-phone-btn">Save</button>
                            <button class="cancel-phone-btn">Cancel</button>
                        </div>
                    </div>
                </div>
                <div class="profile-divider"></div>
                <a href="c_triphistrory.html" class="profile-option">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path>
                    </svg>
                    <span class="history-text">History</span>
                </a>
                <div class="profile-divider"></div>
                <a href="#" class="profile-option sign-out" id="logoutBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span class="logout-text">Logout</span>
                </a>
            </div>
        </div>
    </div>
</header>
<main>
    <div class="booking-card">
        <h2 class="book-trip-text">Book Your Trip</h2>
        <form id="bookingForm">
            <div class="form-group">
                <label for="from" class="from-label">From</label>
                <input type="text" id="from" class="autocomplete-input" placeholder="Enter pickup location" required>
            </div>
            <div class="form-group">
                <label for="to" class="to-label">To</label>
                <input type="text" id="to" class="autocomplete-input" placeholder="Enter destination" required>
            </div>
            <div class="form-group">
                <label for="date" class="date-label">Date</label>
                <div class="date-picker-container">
                    <input type="date"
                           id="date"
                           name="date"
                           required
                           min="2024-03-20"
                           max="2024-12-31">
                </div>
            </div>
            <button type="submit" class="book-now-btn">Book Now</button>
        </form>
    </div>
</main>

<script type="module">

    if (!localStorage.getItem('idToken') || !localStorage.getItem('email')) {
        document.body.innerHTML = '';
        window.location.href = 'login.html';
    }



    const translations = {
        en: {
            bookTrip: "Book Your Trip",
            from: "From",
            to: "To",
            date: "Date",
            bookNow: "Book Now",
            history: "History",
            logout: "Logout",
            enterPickup: "Enter pickup location",
            enterDestination: "Enter destination"
        },
        hi: {
            bookTrip: "अपनी यात्रा बुक करें",
            from: "से",
            to: "तक",
            date: "तारीख",
            bookNow: "अभी बुक करें",
            history: "इतिहास",
            logout: "लॉग आउट",
            enterPickup: "पिकअप स्थान दर्ज करें",
            enterDestination: "गंतव्य दर्ज करें"
        },
        or: {
            bookTrip: "ଆପଣଙ୍କର ଯାତ୍ରା ବୁକ୍ କରନ୍ତୁ",
            from: "ଠାରୁ",
            to: "କୁ",
            date: "ତାରିଖ",
            bookNow: "ଏବେ ବୁକ୍ କରନ୍ତୁ",
            history: "ଇତିହାସ",
            logout: "ଲଗ୍ ଆଉଟ୍",
            enterPickup: "ପିକଅପ୍ ସ୍ଥାନ ଦାଖଲ କରନ୍ତୁ",
            enterDestination: "ଗନ୍ତବ୍ୟ ସ୍ଥାନ ଦାଖଲ କରନ୍ତୁ"
        },
        bn: {
            bookTrip: "আপনার ট্রিপ বুক করুন",
            from: "থেকে",
            to: "পর্যন্ত",
            date: "তারিখ",
            bookNow: "এখনই বুক করুন",
            history: "ইতিহাস",
            logout: "লগআউট",
            enterPickup: "পিকআপ লোকেশন লিখুন",
            enterDestination: "গন্তব্য লিখুন"
        },
        ta: {
            bookTrip: "உங்கள் பயணத்தை முன்பதிவு செய்யவும்",
            from: "இருந்து",
            to: "வரை",
            date: "தேதி",
            bookNow: "இப்போது முன்பதிவு செய்யவும்",
            history: "வரலாறு",
            logout: "வெளியேறு",
            enterPickup: "பிக்-அப் இடத்தை உள்ளிடவும்",
            enterDestination: "இடத்தை உள்ளிடவும்"
        },
        te: {
            bookTrip: "మీ ప్రయాణాన్ని బుక్ చేయండి",
            from: "నుండి",
            to: "కు",
            date: "తేదీ",
            bookNow: "ఇప్పుడు బుక్ చేయండి",
            history: "చరిత్ర",
            logout: "లాగ్అవుట్",
            enterPickup: "పికప్ స్థానాన్ని నమోదు చేయండి",
            enterDestination: "గమ్యస్థానాన్ని నమోదు చేయండి"
        },
        mr: {
            bookTrip: "आपली ट्रिप बुक करा",
            from: "पासून",
            to: "पर्यंत",
            date: "तारीख",
            bookNow: "आता बुक करा",
            history: "इतिहास",
            logout: "लॉगआउट",
            enterPickup: "पिकअप स्थान प्रविष्ट करा",
            enterDestination: "गंतव्य प्रविष्ट करा"
        }
    };


    document.addEventListener('DOMContentLoaded', async function() {
        const idToken = localStorage.getItem('idToken');
        const email = localStorage.getItem('email');

        if (!idToken || !email) {
            window.location.href = 'login.html';
            return;
        }


        try {
            const response = await fetch(`https://fill-it.onrender.com/get-profile?email=${encodeURIComponent(email)}`, {
                headers: {
                    'Authorization': `Bearer ${idToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch profile');
            }

            const profileData = await response.json();


            document.getElementById('profileName').textContent = profileData.name || 'User';
            document.getElementById('profileEmail').textContent = email;
            document.getElementById('profilePhone').textContent = profileData.phone || 'Not set';
            document.querySelector('.phone-input').value = profileData.phone || '';
        } catch (error) {
            console.error('Error fetching profile:', error);
            alert('Failed to load profile data');
        }
    });


    const languageSelector = document.getElementById('languageSelector');
    languageSelector.addEventListener('change', function() {
        const selectedLang = this.value;
        const translation = translations[selectedLang];


        document.querySelector('.book-trip-text').textContent = translation.bookTrip;
        document.querySelector('.from-label').textContent = translation.from;
        document.querySelector('.to-label').textContent = translation.to;
        document.querySelector('.date-label').textContent = translation.date;
        document.querySelector('.book-now-btn').textContent = translation.bookNow;
        document.querySelector('.history-text').textContent = translation.history;
        document.querySelector('.logout-text').textContent = translation.logout;

        // Update placeholders
        document.getElementById('from').placeholder = translation.enterPickup;
        document.getElementById('to').placeholder = translation.enterDestination;
    });


    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').min = today;


    const nextYear = new Date();
    nextYear.setFullYear(nextYear.getFullYear() + 1);
    document.getElementById('date').max = nextYear.toISOString().split('T')[0];


    const profileIcon = document.querySelector('.profile');
    const profilePopup = document.querySelector('.profile-popup');

    profileIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        profilePopup.classList.toggle('active');
    });

    document.addEventListener('click', function(e) {
        if (!profileIcon.contains(e.target)) {
            profilePopup.classList.remove('active');
        }
    });

    profilePopup.addEventListener('click', function(e) {
        e.stopPropagation();
    });


    const editPhoneBtn = document.querySelector('.edit-phone-btn');
    const phoneNumber = document.querySelector('.phone-number');
    const phoneEditForm = document.querySelector('.phone-edit-form');
    const phoneInput = document.querySelector('.phone-input');
    const savePhoneBtn = document.querySelector('.save-phone-btn');
    const cancelPhoneBtn = document.querySelector('.cancel-phone-btn');

    editPhoneBtn.addEventListener('click', function() {
        phoneEditForm.style.display = 'block';
        phoneInput.focus();
    });

    savePhoneBtn.addEventListener('click', async function() {
        const newPhone = phoneInput.value.trim();
        if (newPhone) {
            try {
                const email = localStorage.getItem('email');
                const idToken = localStorage.getItem('idToken');

                const response = await fetch('https://fill-it.onrender.com/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        email: email,
                        phone: newPhone
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    phoneNumber.textContent = newPhone;
                    phoneEditForm.style.display = 'none';
                    alert('Phone number updated successfully!');
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update phone number');
                }
            } catch (error) {
                console.error('Error updating phone:', error);
                alert(error.message || 'Failed to update phone number');
            }
        }
    });

    cancelPhoneBtn.addEventListener('click', function() {
        phoneInput.value = phoneNumber.textContent;
        phoneEditForm.style.display = 'none';
    });


    document.getElementById('logoutBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        try {
            const idToken = localStorage.getItem('idToken');

            const response = await fetch('https://fill-it.onrender.com/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id_token: idToken })
            });

            if (response.ok) {
                // Clear local storage
                localStorage.removeItem('idToken');
                localStorage.removeItem('email');
                localStorage.removeItem('refreshToken');

                // Redirect to welcome page and force reload to prevent back navigation
                window.location.replace('index.html');
                setTimeout(() => { window.location.reload(true); }, 100);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Logout failed');
            }
        } catch (error) {
            console.error('Logout error:', error);
            alert(error.message || 'Failed to logout. Please try again.');
        }
    });


    document.getElementById('bookingForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const from = document.getElementById('from').value;
        const to = document.getElementById('to').value;
        const date = document.getElementById('date').value;

        try {
            const email = localStorage.getItem('email');
            const idToken = localStorage.getItem('idToken');

            const response = await fetch('https://fill-it.onrender.com/book-trip', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                },
                body: JSON.stringify({
                    email: email,
                    from_location: from,
                    to_location: to,
                    date: date
                })
            });

            if (response.ok) {
                alert('Trip booked successfully! You can now check the status in the history section');
                // Redirect to trip history page after alert is closed
                window.location.href = './c_triphistrory.html';
            } else {
                throw new Error('Failed to book trip');
            }
        } catch (error) {
            console.error('Booking error:', error);
            alert('Failed to book trip. Please try again.');
        }
    });


    function loadGoogleMapsAPI() {
        return new Promise((resolve, reject) => {
            if (window.google && window.google.maps) {
                resolve();
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAOXzRX48gcKoX4ndad2hcSPQ7hxFfdSJs&libraries=places';
            script.async = true;
            script.defer = true;
            script.onerror = reject;
            script.onload = () => resolve();
            document.head.appendChild(script);
        });
    }

    async function initAutocomplete() {
        await loadGoogleMapsAPI();
        new google.maps.places.Autocomplete(document.getElementById('from'), { types: ['geocode'] });
        new google.maps.places.Autocomplete(document.getElementById('to'), { types: ['geocode'] });
    }

    document.addEventListener('DOMContentLoaded', initAutocomplete);
</script>
</body>
</html>